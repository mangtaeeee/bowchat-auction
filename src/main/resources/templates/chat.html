<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì±„íŒ…ë°©</title>
    <style>
        body { margin: 0; font-family: sans-serif; background: #f4f4f4; }
        .chat-wrapper { display: flex; flex-direction: column; height: 100vh; }
        .chat-header { background: #ffe100; padding: 16px; font-weight: bold; }
        .chat-body { flex: 1; overflow-y: auto; padding: 16px; background: white; }
        .chat-footer { display: flex; padding: 10px; border-top: 1px solid #ccc; background: #fff; }
        .chat-footer input { flex: 1; padding: 10px; border-radius: 16px; border: 1px solid #ccc; }
        .chat-footer button { margin-left: 10px; padding: 10px 20px; border-radius: 16px; background: #ffe100; border: none; font-weight: bold; cursor: pointer; }
        .chat-message { margin-bottom: 8px; }
        .mine { text-align: left; color: #444; }      /* ì™¼ìª½ ì •ë ¬ë¡œ ë³€ê²½ */
        .theirs { text-align: right; color: #111; }    /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        .chat-date { text-align: center; font-size: 13px; color: #888; margin: 12px 0; }
    </style>
</head>
<body>
<div class="chat-wrapper">
    <div class="chat-header" id="chatTitle">ì±„íŒ…ë°©</div>
    <div class="chat-body" id="chatBody"></div>

    <!-- ì±„íŒ… ì…ë ¥ -->
    <div class="chat-footer" id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <!-- ì…ì°° ì…ë ¥ -->
    <div class="chat-footer" id="bidInputContainer" style="display: none;">
        <input type="number" id="bidInput" placeholder="ì…ì°° ê¸ˆì•¡ ì…ë ¥">
        <button onclick="sendBid()">ì…ì°°</button>
    </div>
</div>

<script>
    let socket;
    let userId, userEmail;
    const token = localStorage.getItem('jwtToken');

    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(
                atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join('')
            );
            return JSON.parse(jsonPayload);
        } catch (e) {
            return null;
        }
    }

    const payload = parseJwt(token);
    if (payload) {
        userId = payload.userId;
        userEmail = payload.sub || payload.email;
    }

    const params = new URLSearchParams(location.search);
    const roomId = params.get('roomId');

    if (!roomId || !token || !userId || !userEmail) {
        alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
        window.location.href = '/view/product';
    }

    window.onload = async () => {
        await loadMessages();
        await loadAuctionInfo();
        connectSocket();
    };

    function connectSocket() {
        socket = new WebSocket(`ws://${location.host}/ws/chat?token=${token}&roomId=${roomId}`);

        socket.onopen = () => {
            console.log("ğŸ”Œ WebSocket ì—°ê²° ì„±ê³µ");
        };

        socket.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            showMessage(msg);

            if (msg.participantCount !== undefined) {
                showParticipantCount(msg.participantCount);
            }

            if (msg.type === 'AUCTION_END') {
                document.getElementById('bidInputContainer').style.display = 'none';
            }

            if (msg.type === 'AUCTION_BID_FAIL') {
                alert(`âš ï¸ ì…ì°° ì‹¤íŒ¨: ${msg.content}`);
            }

            // ğŸ’° í˜„ì¬ê°€ ê°±ì‹ 
            if (msg.type === 'AUCTION_BROADCAST') {
                const bid = parseInt(msg.content);
                if (!isNaN(bid)) {
                    window.currentAuction.currentPrice = bid;
                }
            }
        };

        socket.onclose = () => {
            console.log("âŒ WebSocket ì—°ê²° ì¢…ë£Œ");
        };
    }

    function showParticipantCount(count) {
        let countEl = document.getElementById('participant-count');
        if (!countEl) {
            countEl = document.createElement('div');
            countEl.id = 'participant-count';
            countEl.style.marginBottom = '12px';
            document.getElementById('chatBody').prepend(countEl);
        }
        countEl.textContent = `ğŸ‘¥ í˜„ì¬ ì°¸ì—¬ì ìˆ˜: ${count}`;
    }

    async function loadMessages() {
        const res = await fetch(`/chat/messages/${roomId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const messages = await res.json();
        messages.forEach(showMessage);
    }

    function showMessage(m) {
        const p = document.createElement('p');
        p.classList.add('chat-message');
        if (m.senderName === userEmail) p.classList.add('mine');
        else p.classList.add('theirs');

        if (m.type === 'CHAT') {
            p.innerText = `${m.senderName}: ${m.content}`;
        } else if (m.type === 'AUCTION_BROADCAST') {
            p.innerHTML = `<strong>[ì…ì°°]</strong> ${m.senderName}ë‹˜ì´ ${m.content}ì› ì…ì°°`;
        } else if (m.type === 'ENTER') {
            p.innerText = `ğŸŸ¢ ${m.senderName}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`;
        } else if (m.type === 'LEAVE') {
            p.innerText = `ğŸ”´ ${m.senderName}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`;
        } else if (m.type === 'AUCTION_END') {
            p.innerHTML = `<strong style="color:red">âš ï¸ ê²½ë§¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</strong>`;
        }
        document.getElementById('chatBody').append(p);
    }

    function sendMessage() {
        const input = document.getElementById('chatInput');
        const txt = input?.value?.trim();
        if (!txt) return;

        const payload = {
            roomId,
            senderId: userId,
            senderName: userEmail,
            type: 'CHAT',
            content: txt
        };
        socket.send(JSON.stringify(payload));
        input.value = '';
    }

    async function loadAuctionInfo() {
        try {
            const res = await fetch(`/api/chat/rooms/${roomId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const room = await res.json();

            if (room.saleType === 'AUCTION') {
                const seller = room.participants.find(p => p.role === 'SELLER');
                console.log(seller)
                const sellerId = seller?.participantId;

                window.currentAuction = {
                    currentPrice: 0,
                    sellerId,
                    endTime: new Date("9999-12-31T23:59:59")
                };

                // íŒë§¤ìì´ë©´ ì…ì°°ì°½ ìˆ¨ê¸°ê¸°
                if (userId !== sellerId) {
                    document.getElementById('bidInputContainer').style.display = 'flex';
                } else {
                    document.getElementById('bidInputContainer').style.display = 'none';
                }
            }
        } catch (e) {
            console.log("ê²½ë§¤ ì•„ë‹˜ ë˜ëŠ” ì—ëŸ¬ ë°œìƒ:", e);
        }
    }

    function sendBid() {
        const input = document.getElementById('bidInput');
        const bidAmount = +input.value;
        const { currentPrice, sellerId, endTime } = window.currentAuction || {};

        if (!bidAmount || isNaN(bidAmount)) {
            alert("ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }
        if (userId === sellerId) {
            alert("íŒë§¤ìëŠ” ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }
        if (bidAmount <= currentPrice) {
            alert(`ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ê°€(${currentPrice})ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`);
            return;
        }
        if (new Date() > endTime) {
            alert("ê²½ë§¤ê°€ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        const payload = {
            roomId,
            senderId: userId,
            senderName: userEmail,
            type: 'AUCTION_BID',
            content: bidAmount
        };
        socket.send(JSON.stringify(payload));
        input.value = '';
    }
</script>
</body>
</html>