<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8">
        <title>WebSocket Chat</title>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    </head>
    <body>
    <h2>WebSocket Chat</h2>

    <div>
        <label>ì±„íŒ…ë°© ID:</label>
        <input type="text" id="roomId" placeholder="roomId ì…ë ¥">
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>

    <div>
        <label>ì´ë¦„:</label>
        <input type="text" id="username" placeholder="ì´ë¦„ ì…ë ¥">
        <br>
        <label>ë©”ì‹œì§€:</label>
        <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <h3>ì±„íŒ… ë¡œê·¸</h3>
    <div id="chat" style="border: 1px solid #ccc; padding: 10px; min-height: 200px;"></div>

    <script>
        let stompClient = null;
        let roomId = null;
        let isRoomValid = false;
        let subscription = null;  // ğŸš€ ì¶”ê°€: í˜„ì¬ êµ¬ë…ì„ ì €ì¥í•  ë³€ìˆ˜

        function connect() {
            roomId = document.getElementById("roomId").value;
            if (!roomId) {
                alert("ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            console.log(`ì±„íŒ…ë°© ID: ${roomId}`);

            // âœ… ì±„íŒ…ë°© ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ì—°ê²°
            fetch(`/chat/rooms/${roomId}`)
                .then(response => {
                    console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);

                    if (response.status === 404) {
                        alert("ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        isRoomValid = false;
                        return;
                    }

                    isRoomValid = true;
                    openWebSocket();
                })
                .catch(error => {
                    console.error("ì±„íŒ…ë°© ìš”ì²­ ì‹¤íŒ¨:", error);
                    isRoomValid = false;
                });
        }

        function openWebSocket() {
            let chatDiv = document.getElementById("chat");
            chatDiv.innerHTML = '';  // âœ… ê¸°ì¡´ ì±„íŒ… ë‚´ì—­ ì´ˆê¸°í™”

            if (stompClient !== null && stompClient.connected) {
                console.log("ğŸ”„ ê¸°ì¡´ WebSocket ì—°ê²° í•´ì œ ì¤‘...");
                disconnect();
            }

            let socket = new SockJS('/ws/chat');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log("âœ… WebSocket Connected:", frame);

                // âœ… ê¸°ì¡´ êµ¬ë…ì´ ìˆë‹¤ë©´ ë¨¼ì € í•´ì œ
                if (subscription !== null) {
                    subscription.unsubscribe();
                    console.log("ğŸš€ ê¸°ì¡´ êµ¬ë… í•´ì œ ì™„ë£Œ!");
                }

                // âœ… ìƒˆë¡œìš´ ì±„íŒ…ë°© êµ¬ë… ì„¤ì •
                subscription = stompClient.subscribe('/topic/chat/' + roomId, function (message) {
                    let messageBody = JSON.parse(message.body);
                    if (messageBody.roomId == roomId) {
                        showMessage(messageBody);
                    }
                });

            }, function (error) {
                console.error("âŒ WebSocket connection error: ", error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                console.log("ğŸš« WebSocket ì—°ê²° í•´ì œ");
                stompClient.disconnect();
            }
            if (subscription !== null) {
                subscription.unsubscribe();
                console.log("ğŸ”„ êµ¬ë… í•´ì œ ì™„ë£Œ");
                subscription = null;
            }
        }

        function sendMessage() {
            if (!isRoomValid) {
                alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì±„íŒ…ë°©ì…ë‹ˆë‹¤. ë°© IDë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                return;
            }

            let username = document.getElementById("username").value;
            let message = document.getElementById("message").value;
            if (!roomId || !username || !message) {
                alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            let chatMessage = {
                roomId: roomId,
                sender: username,
                message: message
            };

            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        }

        function showMessage(message) {
            let chatDiv = document.getElementById("chat");
            let newMessage = document.createElement("p");
            newMessage.textContent = message.sender + ": " + message.message;
            chatDiv.appendChild(newMessage);
        }
    </script>

    </body>
</html>
