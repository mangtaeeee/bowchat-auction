<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>BowChat Marketplace</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        section { margin-bottom: 40px; }
        .product { border:1px solid #ddd; padding:10px; margin:5px 0; }
        button { margin-left: 10px; }
        #chatContainer { border:1px solid #ccc; padding:10px; display:none; }
        #chat { height:200px; overflow-y:auto; border:1px solid #eee; padding:5px; }
        #logoutBtn { position: absolute; top: 20px; right: 20px; }
    </style>
</head>
<body>

<button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
<h1>ğŸ”§ ìƒí’ˆ ë“±ë¡</h1>
<section>
    <form id="product-form">
        <input type="text" id="p-name" placeholder="ìƒí’ˆëª…" required><br><br>
        <textarea id="p-desc" placeholder="ì„¤ëª…" required></textarea><br><br>
        <input type="number" id="p-price" placeholder="ê°€ê²©" required><br><br>
        <input type="url" id="p-img" placeholder="ì´ë¯¸ì§€ URL"><br><br>

        <label><input type="radio" name="saleType" value="DIRECT" checked> ì§ê±°ë˜</label>
        <label><input type="radio" name="saleType" value="AUCTION"> ê²½ë§¤</label><br><br>

        <div id="auction-options" style="display:none;">
            <label>ê²½ë§¤ ì¢…ë£Œ ì‹œê°„:</label>
            <input type="datetime-local" id="p-endTime"><br><br>
        </div>

        <button type="submit">ìƒí’ˆ ë“±ë¡</button>
    </form>
</section>

<h2>ğŸ· ê²½ë§¤ ìƒí’ˆ</h2>
<section id="auction-list"></section>

<h2>ğŸ›’ ì§ê±°ë˜ ìƒí’ˆ ë¬¸ì˜</h2>
<section id="direct-list"></section>

<h2>ğŸ’¬ ì±„íŒ…</h2>
<div id="chatContainer">
    <div><strong>Room #<span id="room-id"></span></strong></div><br>
    <div id="chat"></div><br>
    <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button onclick="sendMessage()">ì „ì†¡</button>
    <!-- ì…ì°° UI ì¶”ê°€ -->
    <div id="bid-area" style="display:none; margin-top:10px;">
        <input type="number" id="bid-amount" placeholder="ì…ì°° ê¸ˆì•¡ ì…ë ¥">
        <button onclick="sendBid()">ì…ì°°</button>
    </div>
    <button onclick="leaveRoom()">ë‚˜ê°€ê¸°</button>
</div>

<script>
    let socket, roomId;

    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.clear();
        alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
        location.href = '/login.html';
    });

    window.onload = async () => {
        const params = new URLSearchParams(location.search);
        const token = params.get('token');
        if (token) {
            localStorage.setItem('jwtToken', token);
            const payload = JSON.parse(atob(token.split('.')[1]));
            localStorage.setItem('userEmail', payload.sub);
            if (payload.userId) {
                localStorage.setItem('userId', payload.userId);
            }
            history.replaceState({}, document.title, location.pathname);
        }

        const savedToken = localStorage.getItem('jwtToken');
        if (!savedToken) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            location.href = '/login.html';
            return;
        }

        document.querySelectorAll('[name=saleType]').forEach(el => {
            el.addEventListener('change', () => {
                document.getElementById('auction-options').style.display =
                    document.querySelector('[name=saleType]:checked').value === 'AUCTION'
                        ? 'block' : 'none';
            });
        });

        document.getElementById('product-form').addEventListener('submit', onProductSubmit);
        await loadProducts();
    };

    async function onProductSubmit(e) {
        e.preventDefault();
        const token = localStorage.getItem('jwtToken');
        const dto = {
            name: document.getElementById('p-name').value,
            description: document.getElementById('p-desc').value,
            price: +document.getElementById('p-price').value,
            imageUrl: document.getElementById('p-img').value,
            categoryId: 1,
            sellerId: +localStorage.getItem('userId')
        };

        const res = await fetch('/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(dto)
        });
        if (!res.ok) return alert('ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨');

        const productId = await res.json(); // ì‘ë‹µì€ Long ê°’

        if (document.querySelector('[name=saleType]:checked').value === 'AUCTION') {
            const raw = document.getElementById('p-endTime').value;
            if (!raw) return alert('ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”');
            const endTime = raw.replace('T',' ') + ':00';

            const resAuc = await fetch(`/auctions/${productId}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ endTime })
            });
            if (!resAuc.ok) return alert('ê²½ë§¤ ì‹œì‘ ì‹¤íŒ¨');
        }

        window.location.reload();
    }

    async function loadProducts() {
        const token = localStorage.getItem('jwtToken');
        const [prods, auctions] = await Promise.all([
            fetch('/products', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
            fetch('/auctions', { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
        ]);

        const aucList = document.getElementById('auction-list');
        aucList.innerHTML = '';
        auctions.forEach(a => {
            const div = document.createElement('div');
            div.className = 'product';
            div.innerHTML = `
      <strong>${a.productName}</strong> (í˜„ì¬ê°€: ${a.currentPrice}ì›)<br>
      ì¢…ë£Œ: ${new Date(a.endTime).toLocaleString()}
      <button onclick="enterRoom(${a.id}, 'AUCTION')">ê²½ë§¤ ì°¸ì—¬</button>
    `;
            aucList.append(div);
        });

        const dirList = document.getElementById('direct-list');
        dirList.innerHTML = '';
        prods.forEach(p => {
            if (auctions.some(a => a.productId === p.id)) return;
            const div = document.createElement('div');
            div.className = 'product';
            div.innerHTML = `
      <strong>${p.name}</strong> (${p.startingPrice}ì›)<br>
      <button onclick="enterRoom(${p.id}, 'DIRECT')">ì±„íŒ… ë¬¸ì˜</button>
    `;
            dirList.append(div);
        });
    }

    async function enterRoom(id, type) {
        const token = localStorage.getItem('jwtToken');
        const res = await fetch(`/chat/rooms/${type}?productId=${id}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return alert('ë°© ìƒì„±/ì¡°íšŒ ì‹¤íŒ¨');

        const room = await res.json();
        roomId = room.roomId;
        chatType = type;
        document.getElementById('room-id').innerText = roomId;
        document.getElementById('chatContainer').style.display = 'block';

        // ë©”ì‹œì§€ ë¡œë”©
        const msgs = await fetch(`/chat/messages/${roomId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(r => r.json());
        const chatDiv = document.getElementById('chat');
        chatDiv.innerHTML = '';
        msgs.forEach(showMsg);

        // WebSocket
        if (socket) socket.close();
        socket = new WebSocket(`ws://${location.host}/ws/chat?token=${token}&roomId=${roomId}`);
        socket.onmessage = e => showMsg(JSON.parse(e.data));

        // ë¹„ë“œ ì˜ì—­ ì¡°ê±´ë¶€ ë Œë”ë§
        if (chatType === 'AUCTION') {
            const userId = +localStorage.getItem('userId');
            const productRes = await fetch(`/auctions/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const auction = await productRes.json();

            window.currentAuctionData = {
                currentPrice: auction.currentPrice,
                sellerId: auction.sellerId
            };

            if (auction.sellerId !== userId) {
                document.getElementById('bid-area').style.display = 'block';
            } else {
                document.getElementById('bid-area').style.display = 'none';
            }
        }
    }

    // ì…ì°° ë©”ì‹œì§€ ì „ì†¡
    function sendBid() {
        const amount = +document.getElementById('bid-amount').value;
        if (!amount || amount <= 0) return alert('ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');

        socket.send(JSON.stringify({
            roomId,
            senderId: +localStorage.getItem('userId'),
            senderName: localStorage.getItem('userEmail'),
            type: 'BID',
            content: amount
        }));

        document.getElementById('bid-amount').value = '';
    }
    function showMsg(m) {
        const p = document.createElement('p');
        if (m.type === 'BID') {
            p.innerHTML = `<strong>[ì…ì°°]</strong> ${m.senderName}ë‹˜ì´ ${m.content}ì› ì…ì°°`;
        } else {
            p.textContent = `[${m.type}] ${m.senderName}: ${m.content}`;
        }
        document.getElementById('chat').append(p);
    }
    function sendMessage() {
        const txt = document.getElementById('msg-input').value;
        if (!txt) return;

        const userId = +localStorage.getItem('userId');
        const userEmail = localStorage.getItem('userEmail');

        const type = chatType; // 'AUCTION' ë˜ëŠ” 'DIRECT'

        if (type === 'AUCTION') {
            const auctionData = window.currentAuctionData; // ì•„ë˜ enterRoomì—ì„œ ì €ì¥í•¨
            const currentPrice = auctionData.currentPrice;
            const sellerId = auctionData.sellerId;

            const bid = parseInt(txt);

            // 1. íŒë§¤ì ì…ì°° ì œí•œ
            if (userId === sellerId) {
                alert("íŒë§¤ìëŠ” ìì‹ ì˜ ê²½ë§¤ì— ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // 2. ìˆ«ì ì•„ë‹˜ or í˜„ì¬ê°€ ì´í•˜
            if (isNaN(bid) || bid <= currentPrice) {
                alert(`ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ê°€ (${currentPrice}ì›) ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`);
                return;
            }

            // âœ… ìœ íš¨í•œ ê²½ë§¤ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬
            socket.send(JSON.stringify({
                roomId,
                senderId: userId,
                senderName: userEmail,
                type: 'CHAT',
                content: String(bid)  // ì…ì°°ê°€ ì „ì†¡
            }));

        } else {
            // âœ… ì¼ë°˜ ì§ê±°ë˜ ì±„íŒ…
            socket.send(JSON.stringify({
                roomId,
                senderId: userId,
                senderName: userEmail,
                type: 'CHAT',
                content: txt
            }));
        }

        document.getElementById('msg-input').value = '';
    }

    function leaveRoom() {
        socket.send(JSON.stringify({
            roomId,
            senderId: +localStorage.getItem('userId'),
            senderName: localStorage.getItem('userEmail'),
            type: 'LEAVE',
            content: ''
        }));
        socket.close();
        document.getElementById('chatContainer').style.display = 'none';
        loadProducts();
    }
</script>

</body>
</html>