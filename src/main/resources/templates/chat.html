<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>
<body>

<h2>WebSocket Chat</h2>
<button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
<!-- ì±„íŒ…ë°© ìƒì„± -->
<div>
    <label>ìƒˆ ì±„íŒ…ë°© ì´ë¦„:</label>
    <input type="text" id="newRoomName" placeholder="ì±„íŒ…ë°© ì´ë¦„ ì…ë ¥">
    <button onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„±</button>
</div>

<!-- ì±„íŒ…ë°© ëª©ë¡ -->
<h3>ì±„íŒ…ë°© ëª©ë¡</h3>
<div id="chatRooms"></div>

<!-- ì±„íŒ…ë°© ì…ì¥ -->
<h3>ì±„íŒ…ë°© ì…ì¥</h3>
<div>
    <label>ì±„íŒ…ë°© ID:</label>
    <input type="text" id="roomId" placeholder="roomId ì…ë ¥">
    <button onclick="connect()">ì—°ê²°</button>
    <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
</div>

<!-- ë©”ì‹œì§€ ì…ë ¥ -->
<div>
    <label>ë©”ì‹œì§€:</label>
    <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button onclick="sendMessage()">ì „ì†¡</button>
</div>

<!-- ì±„íŒ… ë¡œê·¸ -->
<h3>ì±„íŒ… ë¡œê·¸</h3> <!-- ì±„íŒ…ë°© í‡´ì¥ ë²„íŠ¼ -->
<button onclick="leaveChatRoom()">ì±„íŒ…ë°© í‡´ì¥</button>
<div id="chat" style="border: 1px solid #ccc; padding: 10px; min-height: 200px;"></div>

<script>
    let stompClient = null;
    let roomId = null;
    let isRoomValid = false;
    let subscription = null;

    function createChatRoom() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        const chatRoomName = document.getElementById("newRoomName").value;
        if (!chatRoomName) {
            alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        fetch("/chat/rooms", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ chatRoomName })
        })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    localStorage.clear();
                    window.location.href = '/login';
                    return;
                }
                if (response.ok) {
                    alert("ì±„íŒ…ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadChatRooms();
                } else {
                    alert("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨.");
                }
            });
    }

    function loadChatRooms() {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
            return;
        }

        fetch("/chat/rooms", {
            headers: { "Authorization": `Bearer ${token}` }
        })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    localStorage.clear();
                    window.location.href = '/login';
                    return;
                }
                return response.json();
            })
            .then(data => {
                const chatRoomsDiv = document.getElementById("chatRooms");
                chatRoomsDiv.innerHTML = "";
                data.forEach(room => {
                    let roomElement = document.createElement("p");
                    roomElement.innerHTML = `<b>${room.roomId}</b>: ${room.roomName}
                    <button onclick="joinRoom(${room.roomId})">ì…ì¥</button>`;
                    chatRoomsDiv.appendChild(roomElement);
                });
            });
    }

    function joinRoom(selectedRoomId) {
        const token = localStorage.getItem('jwtToken');
        fetch(`/chat/rooms/${selectedRoomId}`, {
            headers: {"Authorization": `Bearer ${token}`}
        })
            .then(response => {
                if (response.status === 401 || response.status === 403) {
                    alert("ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    localStorage.clear();
                    window.location.href = '/login';
                    return;
                }
                if (!response.ok) {
                    alert("ì±„íŒ…ë°© ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨.");
                    return;
                }
                return response.json();
            })
            .then(data => {
                console.log("ì±„íŒ…ë°© ì •ë³´:", data); // ë””ë²„ê¹…ìš©
                document.getElementById("roomId").value = selectedRoomId;
                loadPreviousMessages(selectedRoomId);
                connect();
            });
    }

    function loadPreviousMessages(roomId) {
        const token = localStorage.getItem('jwtToken');
        fetch(`/chat/messages/${roomId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        })
            .then(response => response.json())
            .then(messages => {
                const chatDiv = document.getElementById("chat");
                chatDiv.innerHTML = '';
                messages.forEach(message => showMessage(message));
            });
    }

    function connect() {
        roomId = document.getElementById("roomId").value;
        fetch(`/chat/rooms/${roomId}`)
            .then(response => {
                if (response.status === 404) {
                    alert("ì±„íŒ…ë°©ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    isRoomValid = false;
                    return;
                }
                isRoomValid = true;
                openWebSocket();
            });
    }

    function openWebSocket() {
        const chatDiv = document.getElementById("chat");
        chatDiv.innerHTML = '';
        if (stompClient !== null && stompClient.connected) disconnect();

        const token = localStorage.getItem('jwtToken');
        const socket = new SockJS('/ws/chat?token=' + token); // âœ… ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— í† í° ë¶™ì„
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            if (subscription !== null) subscription.unsubscribe();
            subscription = stompClient.subscribe('/topic/chat/' + roomId, function (message) {
                const messageBody = JSON.parse(message.body);
                console.log("ğŸ“© ìˆ˜ì‹ ëœ ë©”ì‹œì§€:", messageBody);
                console.log("roomId ë¹„êµ:", messageBody.roomId, roomId);
                if (String(messageBody.roomId) === String(roomId)) {
                    showMessage(messageBody);
                }
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) stompClient.disconnect();
        if (subscription !== null) {
            subscription.unsubscribe();
            subscription = null;
        }
    }

    function sendMessage() {
        if (!isRoomValid) {
            alert("ìœ íš¨í•˜ì§€ ì•Šì€ ì±„íŒ…ë°©ì…ë‹ˆë‹¤.");
            return;
        }

        const sender = localStorage.getItem("userEmail");
        const message = document.getElementById("message").value;
        const messageInput = document.getElementById("message");

        if (!roomId || !sender || !message) {
            alert("ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const chatMessage = {
            roomId: roomId,
            sender: sender,
            message: message
        };

        stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
        messageInput.value = "";
    }

    function showMessage(message) {
        const chatDiv = document.getElementById("chat");
        const newMessage = document.createElement("p");
        newMessage.textContent = message.sender + ": " + message.message;
        chatDiv.appendChild(newMessage);
    }
    function logout() {
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userEmail");
        alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/login";
    }
    function leaveChatRoom() {
        const token = localStorage.getItem('jwtToken');
        if (!roomId || !token) {
            alert("ì±„íŒ…ë°©ì— ì…ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            return;
        }

        fetch(`/chat/rooms/${roomId}/leave`, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${token}`
            }
        })
            .then(response => {
                if (response.ok) {
                    alert("ì±„íŒ…ë°©ì—ì„œ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.");
                    disconnect(); // âœ… WebSocket ì—°ê²° í•´ì œ
                    clearChatLog(); // âœ… ì±„íŒ… ë¡œê·¸ ì´ˆê¸°í™”
                    loadChatRooms(); // ì±„íŒ…ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert("ì±„íŒ…ë°© í‡´ì¥ ì‹¤íŒ¨");
                }
            });
    }

    function clearChatLog() {
        const chatDiv = document.getElementById("chat");
        chatDiv.innerHTML = ''; // âœ… ì±„íŒ… ë¡œê·¸ ë¹„ìš°ê¸°
    }

    window.onload = function () {
        // 1. ë¨¼ì € í† í° íŒŒì‹±
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");

        if (token) {
            try {
                localStorage.setItem("jwtToken", token);
                const payload = JSON.parse(atob(token.split('.')[1]));
                const email = payload.sub;
                localStorage.setItem("userEmail", email);

                // URL ì •ë¦¬
                const url = new URL(window.location);
                url.searchParams.delete("token");
                window.history.replaceState({}, document.title, url);
            } catch (e) {
                console.error("JWT ì²˜ë¦¬ ì˜¤ë¥˜:", e);
            }
        }

        // 2. í† í° í™•ì¸ í›„ ì±„íŒ…ë°© ë¶ˆëŸ¬ì˜¤ê¸°
        const jwt = localStorage.getItem("jwtToken");
        const userEmail = localStorage.getItem("userEmail");

        if (!jwt || !userEmail) {
            alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
            window.location.href = "/login";
            return;
        }

        loadChatRooms();
    };
</script>

</body>
</html>