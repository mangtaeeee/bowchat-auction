    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Kafka WebSocket Chat</title>
    </head>
    <body>

    <h2>WebSocket Chat</h2>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <!-- ì±„íŒ…ë°© ìƒì„± -->
    <div>
        <label>ìƒˆ ì±„íŒ…ë°© ì´ë¦„:</label>
        <input type="text" id="newRoomName" placeholder="ì±„íŒ…ë°© ì´ë¦„ ì…ë ¥">
        <button onclick="createChatRoom()">ì±„íŒ…ë°© ìƒì„±</button>
    </div>

    <!-- ì±„íŒ…ë°© ëª©ë¡ -->
    <h3>ì±„íŒ…ë°© ëª©ë¡</h3>
    <div id="chatRooms"></div>

    <!-- ì±„íŒ…ë°© ì…ì¥ -->
    <h3>ì±„íŒ…ë°© ì…ì¥</h3>
    <div>
        <label>ì±„íŒ…ë°© ID:</label>
        <input type="text" id="roomId" placeholder="roomId ì…ë ¥">
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>

    <!-- ë©”ì‹œì§€ ì…ë ¥ -->
    <div>
        <label>ë©”ì‹œì§€:</label>
        <input type="text" id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
        <button onclick="sendMessage()">ì „ì†¡</button>
    </div>

    <!-- ì±„íŒ… ë¡œê·¸ -->
    <h3>ì±„íŒ… ë¡œê·¸</h3>
    <button onclick="leaveChatRoom()">ì±„íŒ…ë°© í‡´ì¥</button>
    <div id="chat" style="border: 1px solid #ccc; padding: 10px; min-height: 200px;"></div>

    <script>
        let socket = null;
        let roomId = null;

        function createChatRoom() {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            const chatRoomName = document.getElementById("newRoomName").value;
            if (!chatRoomName) {
                alert("ì±„íŒ…ë°© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            fetch("/chat/rooms", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ chatRoomName })
            })
                .then(response => response.ok ? alert("ì±„íŒ…ë°© ìƒì„± ì™„ë£Œ") : alert("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨"))
                .then(loadChatRooms);
        }

        function loadChatRooms() {
            const token = localStorage.getItem('jwtToken');
            fetch("/chat/rooms", {
                headers: {"Authorization": `Bearer ${token}`}
            })
                .then(response => response.json())
                .then(data => {
                    const chatRoomsDiv = document.getElementById("chatRooms");
                    chatRoomsDiv.innerHTML = "";
                    data.forEach(room => {
                        let roomElement = document.createElement("p");
                        roomElement.innerHTML = `<b>${room.roomId}</b>: ${room.roomName}
                        <button onclick="joinRoom(${room.roomId})">ì…ì¥</button>`;
                        chatRoomsDiv.appendChild(roomElement);
                    });
                });
        }

        function joinRoom(selectedRoomId) {
            const token = localStorage.getItem('jwtToken');

            fetch(`/chat/rooms/${selectedRoomId}`, {
                headers: {"Authorization": `Bearer ${token}`}
            })
                .then(response => {
                    if (!response.ok) throw new Error("ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨");
                    return response.json();
                })
                .then(data => {
                    console.log("ì±„íŒ…ë°© ì…ì¥ ì„±ê³µ:", data);
                    document.getElementById("roomId").value = selectedRoomId;
                    loadPreviousMessages(selectedRoomId); // ê³¼ê±° ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                    connect(); // WebSocket ì—°ê²°
                })
                .catch(err => {
                    alert("ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨: " + err.message);
                });
        }

        function loadPreviousMessages(roomId) {
            const token = localStorage.getItem('jwtToken');
            fetch(`/chat/messages/${roomId}`, {
                headers: {"Authorization": `Bearer ${token}`}
            })
                .then(response => response.json())
                .then(messages => {
                    const chatDiv = document.getElementById("chat");
                    chatDiv.innerHTML = '';
                    messages.forEach(showMessage);
                });
        }

        function connect() {
            if (socket !== null && socket.readyState === WebSocket.OPEN) {
                socket.close();
            }

            const token = localStorage.getItem('jwtToken');
            roomId = document.getElementById("roomId").value;

            socket = new WebSocket("ws://localhost:8080/ws/chat?token=" + token + "&roomId=" + roomId);

            socket.onopen = () => {
                console.log("WebSocket ì—°ê²° ì„±ê³µ");
            };

            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                console.log("ğŸ“© ë°›ì€ ë©”ì‹œì§€:", message);
                showMessage(message);
            };

            socket.onclose = () => {
                console.log("WebSocket ì—°ê²° ì¢…ë£Œ");
            };

            socket.onerror = (error) => {
                console.error("WebSocket ì˜¤ë¥˜:", error);
            };
        }

        function disconnect() {
            if (socket !== null) {
                socket.close();
            }
        }

        function sendMessage() {
            const senderId = localStorage.getItem("userId");
            const senderName = localStorage.getItem("userEmail");
            const messageText = document.getElementById("message").value;

            if (!messageText) {
                alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                return;
            }

            const chatMessage = {
                roomId: roomId,
                senderId: senderId,
                senderName: senderName,
                type: "CHAT",
                content: messageText
            };

            socket.send(JSON.stringify(chatMessage));
            document.getElementById("message").value = '';
        }

        function showMessage(message) {
            const chatDiv = document.getElementById("chat");
            const newMessage = document.createElement("p");
            console.log(message)
            newMessage.textContent = `[${message.type}] ${message.senderName}: ${message.content}`;
            chatDiv.appendChild(newMessage);
        }

        function logout() {
            localStorage.clear();
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/login";
        }

        function leaveChatRoom() {
            if (!roomId) return alert("í˜„ì¬ ì±„íŒ…ë°©ì— ì…ì¥í•´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");

            // 1) LEAVE ì´ë²¤íŠ¸ ë°œí–‰ (Kafka â†’ Consumer â†’ DB/ë¸Œë¡œë“œìºìŠ¤íŠ¸)
            const leaveEvent = {
                roomId,
                senderId: localStorage.getItem("userId"),
                senderName: localStorage.getItem("userEmail"),
                type: "LEAVE",
                content: ""
            };
            socket.send(JSON.stringify(leaveEvent));

            // 2) í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ì •ë¦¬
            disconnect();      // WebSocket close
            clearChatLog();    // UI ì²­ì†Œ
            loadChatRooms();   // ë°© ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        }

        function clearChatLog() {
            document.getElementById("chat").innerHTML = '';
        }

        window.onload = () => {
            const token = new URLSearchParams(window.location.search).get("token");
            if (token) {
                localStorage.setItem("jwtToken", token);
                const payload = JSON.parse(atob(token.split('.')[1]));
                localStorage.setItem("userEmail", payload.sub);
                localStorage.setItem("userId", payload.userId);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            loadChatRooms();
        };
    </script>

    </body>
    </html>