<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>상품 등록</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            max-width: 600px;
            margin: auto;
            background-color: #f9fafb;
        }
        h1 {
            color: #111827;
            margin-bottom: 24px;
        }
        label {
            display: block;
            margin-top: 16px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            margin-top: 24px;
            background-color: #2563eb;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #1e40af;
        }
        #preview img {
            width: 100px;
            margin: 8px 8px 0 0;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<h1>상품 등록</h1>
<form id="product-form">
    <label for="name">상품명</label>
    <input type="text" id="name" required>

    <label for="description">설명</label>
    <textarea id="description" required></textarea>

    <label for="startingPrice">가격</label>
    <input type="number" id="startingPrice" required>

    <label for="saleType">판매 방식</label>
    <select id="saleType" required>
        <option value="DIRECT">직거래</option>
        <option value="AUCTION">경매</option>
    </select>

    <div id="auction-fields" style="display:none;">
        <label for="endTime">경매 종료 시간</label>
        <input type="datetime-local" id="endTime">
    </div>

    <label for="images">이미지 업로드</label>
    <input type="file" id="images" name="images" accept="image/*" multiple required />
    <div id="preview"></div>

    <button type="submit">등록하기</button>
</form>

<script>
    const imageUrls = [];

    // 판매 방식 선택에 따라 종료시간 입력 필드 표시 여부 결정
    document.getElementById("saleType").addEventListener("change", function () {
        const isAuction = this.value === "AUCTION";
        document.getElementById("auction-fields").style.display = isAuction ? "block" : "none";
    });

    document.getElementById("images").addEventListener("change", async function (e) {
        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            location.href = "/view/login";
            return;
        }

        const files = e.target.files;
        const preview = document.getElementById("preview");
        preview.innerHTML = "";
        imageUrls.length = 0;

        for (const file of files) {
            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch("/api/uploads", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    body: formData
                });

                if (!res.ok) {
                    throw new Error("업로드 실패");
                }

                const { url } = await res.json();
                imageUrls.push(url);

                const img = document.createElement("img");
                img.src = new URL(url, location.origin).href;
                preview.appendChild(img);
            } catch (err) {
                console.error(`${file.name} 업로드 실패`, err);
                alert(`${file.name} 업로드 실패`);
            }
        }
    });

    document.getElementById("product-form").addEventListener("submit", async function (e) {
        e.preventDefault();

        const token = localStorage.getItem("jwtToken");
        if (!token) {
            alert("로그인이 필요합니다.");
            location.href = "/view/login";
            return;
        }

        if (imageUrls.length === 0) {
            alert("이미지를 먼저 업로드해주세요.");
            return;
        }

        const saleType = document.getElementById("saleType").value;
        const body = {
            name: document.getElementById("name").value,
            description: document.getElementById("description").value,
            price: parseInt(document.getElementById("startingPrice").value),
            saleType,
            imageUrls
        };

        try {
            const res = await fetch("/api/products", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const errorText = await res.text();
                console.error("상품 등록 실패", errorText);
                alert("상품 등록 실패!");
                return;
            }

            const productId = await res.json();
            console.log("상품 등록 성공 ID:", productId);

            // 경매일 경우 종료시간 포함하여 경매 시작 요청
            if (saleType === "AUCTION") {
                const endTimeInput = document.getElementById("endTime").value;
                if (!endTimeInput) {
                    alert("경매 종료 시간을 입력해주세요.");
                    return;
                }

                const endTime = endTimeInput.replace("T", " ") + ":00";

                // 1. 경매 시작 요청
                const res2 = await fetch(`/api/auctions/${productId}/start`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ endTime })
                });

                if (!res2.ok) {
                    const errorText = await res2.text();
                    console.error("경매 시작 실패", errorText);
                    alert("경매 시작 실패!");
                    return;
                }

                // 2. 경매 채팅방 생성 요청
                const res3 = await fetch(`/api/chat/rooms/AUCTION?productId=${productId}`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!res3.ok) {
                    const errorText = await res3.text();
                    console.error("경매 채팅방 생성 실패", errorText);
                    alert("채팅방 생성 실패!");
                    return;
                }

                console.log("경매 채팅방 생성 완료");
            }

            alert("상품 등록 성공!");
            location.href = "/view/product";

        } catch (err) {
            console.error("에러:", err);
            alert("등록 중 문제가 발생했습니다.");
        }
    });
</script>
</body>
</html>